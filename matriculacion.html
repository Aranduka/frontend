<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <title>Matriculacion</title>
</head>
<body>
    <a href="http://localhost:8000/contratos" download="foto">Descargar</a>
    <div class="row">
      <div class="col s12">
        <div class="row">
          <div class="input-field col s6">
            <input type="text" placeholder="Cedula del Alumno" id="alumno_cedula" class="validate">
            <label for="cedula">C.I Alumno</label>
          </div>
          <div class="col s6">
            <button class="btn green darken-4" style="margin-top: 20px;">Buscar</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s6">
          <input type="text" class="validate" placeholder="Juan" id="nombre_alumno" disabled>
          <label for="nombre_alumno">Nombre Alumno</label>
        </div>
        <div class="input-field col s6">
          <input type="text" class="validate" placeholder="Perez" disabled id="apellido_alumno">
          <label for="apellido_alumno">Apellido Alumno</label>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s6">
          <input type="text" class="validate" placeholder="Cedula del Encargado" id="encargado_cedula">
          <label for="encargado_cedula">C.I Encargado</label>
        </div>
        <div class="col s6">
          <button class="btn green darken-4">Buscar</button>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s6">
          <input type="text" class="validate" placeholder="Nombre del Encargado" disabled id="nombre_encargado">
          <label for="nombre_encargado">Nombre Encargado</label>
        </div>
        <div class="input-field col s6">
          <input type="text" class="validate" placeholder="Apellido del Encargado" disabled id="apellido_encargado">
          <label for="apellido_encargado">Apellido Encargado</label>
        </div>
        <div class="row">
          <div class="input-field col s9">
            <select class="browser-default" id="cursos">
              <option value="" disabled selected>Seleccione un curso</option>
            </select>
          </div>
        </div>
      </div>
      <div class="col s6">
        <button class="btn blue darken-4" id="guardar_matricula">Guardar</button>
        <div id="descarga"></div>
      </div>
      <div class="col s6">
        <button class="btn red darken-4" id="cancelar_matricula">Cancelar</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>

        if (!localStorage.getItem('token')){
            alert('No esta autorizado');
            window.location = "/";
        }

        const url_cursos = "http://localhost:8000/cursos";
        const url_matriculacion = "http://localhost:8000/matriculacion";
        const url_contratos = "http://localhost:8000/contratos";

        document.addEventListener('DOMContentLoaded', function() {
            listar_cursos();
            var elems = document.querySelectorAll('#cursos');
            var instances = M.FormSelect.init(elems);
        });

        

      // Cursos
      
      const btn_cancelar = document.getElementById("cancelar_matricula");
      btn_cancelar.addEventListener("click", function(e){
        window.location = url_contratos + "/45";
          // const texto = `<a id="btn_descarga">Descargar Contrato</a>`;
          // const div_descargar = document.getElementById("descarga");
          // div_descargar.innerHTML = texto
          // const btn_descargar_contrato = document.getElementById("btn_descarga");
          // btn_descargar_contrato.addEventListener("click", function(e){
          //   descargar_contrato(btn_descargar_contrato)
        // });
      });

      const listar_cursos = async () => {
        const solicitud = new Request(
          url_cursos+"/1",
          {
          method: 'Get',
          withCredentials: true,
          credentials: 'include',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem("token"),
            'Content-Type': 'application/json'
          }
        });
        const respuesta = await fetch(solicitud);
        const cursos = await respuesta.json();
        console.log(cursos);
        if (!respuesta.ok){
          alert("Algo fallo al listar los cursos");
        }
        else{
          const selector = document.getElementById("cursos");
          for (let curso of cursos){
            let nueva_opcion = document.createElement("option");
            nueva_opcion.value = curso.id_curso
            nueva_opcion.text = curso.descripcion + " " + curso.seccion + " " + curso.turno;
            selector.appendChild(nueva_opcion);
          }
        }
      };
      
      

      // Matricula

      const btn_guardar_matricula = document.getElementById("guardar_matricula");

      btn_guardar_matricula.addEventListener("click", function(e){
        guardar_matricula();
      });

      const guardar_matricula = async () =>{
        const parametros = {
          "id_alumno": 281,
          "id_encargado": 300,
          "fecha_inscripcion": "2022-02-01",
          "id_curso": 1,
          "id_institucion": 1
        }
        const solicitud = new Request(url_matriculacion, {
          method: 'Post',
          withCredentials: true,
          credentials: 'include',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem("token"),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(parametros)
        });

        const respuesta = await fetch(solicitud);
        const datos = await respuesta.json();
        if (!respuesta.ok){
          alert("Error al intentar ingresar Matricula");
        }
        else{
          alert(datos.mensaje)
          alert(datos.url)
          const texto = `<a id="btn_descarga" href="${url_contratos}/45">Descargar Contrato</a>`;
          const div_descargar = document.getElementById("descarga");
          div_descargar.innerHTML = texto
      
        }
      };

      

      const descargar_contrato = async (btn) => {

        // const solicitud = new Request(
        //   url_contratos+"/60",
        //   {
        //   method:'Get',
        //   withCredentials: true,
        //   credentials: 'include',
        //   headers: {
        //     'Authorization': 'Bearer ' + localStorage.getItem("token"),
        //     'Content-Type': 'application/octet-stream'
        //   }
        // });

        const respuesta = await fetch("http://ddragon.leagueoflegends.com/cdn/img/champion/loading/Aatrox_0.jpg"/*solicitud*/);
        const blob = await respuesta.blob();
        console.log(blob)
        let url = window.URL.createObjectURL(blob);
        console.log(url)
        // btn.href = url;
        // btn.download = "Contrato.docx";
      };

    </script>
</body>
</html>